import streamlit as st
import os
import json

utilizatori_path = "utilizatori.json"

# ✅ Creează fișierul dacă nu există sau este invalid
if not os.path.exists(utilizatori_path) or os.path.getsize(utilizatori_path) == 0:
    default_users = {
        "alexandru": {
            "parola": "parolamea"
        }
    }
    with open(utilizatori_path, "w", encoding="utf-8") as f:
        json.dump(default_users, f, indent=2, ensure_ascii=False)
    users = default_users
else:
    try:
        with open(utilizatori_path, "r", encoding="utf-8") as f:
            continut = f.read().strip()
            if not continut:
                raise ValueError("Fișierul este gol")
            users = json.loads(continut)

        # Validare structură
        if not isinstance(users, dict) or not users:
            raise ValueError("Structură invalidă")
    except Exception as e:
        st.warning("⚠️ Fișierul 'utilizatori.json' era invalid. L-am resetat automat.")
        users = {
            "alexandru": {
                "parola": "parolamea"
            }
        }
        with open(utilizatori_path, "w", encoding="utf-8") as f:
            json.dump(users, f, indent=2, ensure_ascii=False)

# ✅ Selectează utilizatorul activ
current_user = list(users.keys())[0]
user_file = f"jurnale/{current_user}_journal.json"

# ✅ Creează folderul pentru jurnale dacă nu există
os.makedirs("jurnale", exist_ok=True)

st.success(f"✅ Utilizatorul activ este: **{current_user}**")
